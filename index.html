<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Click to Breathe</title>
<style>
  body {font-family:sans-serif;background:#0a0e18;color:#fff;margin:0;padding:0;}
  .container {display:flex;gap:30px;align-items:flex-start;padding:20px;}
  .game {flex:2;text-align:center;display:none;}
  .leaderboard {flex:1;background:#111;padding:15px;border-radius:10px;display:none;}
  button {padding:10px 20px;font-size:18px;margin:10px;border:none;border-radius:8px;background:#6ee7b7;color:#051810;cursor:pointer;transition:.2s;}
  button:disabled {opacity:.5;cursor:not-allowed;}
  .bar {height:20px;background:#222;border-radius:10px;margin:10px 0;overflow:hidden;}
  .fill {height:100%;background:#6ee7b7;width:100%;transition:width .2s;}
  .stats {margin-top:10px;}
  h1 {font-size:clamp(1.5rem,4vw,2.5rem);}
  #audioControls {margin-top:15px;}
  #usernamePrompt {text-align:center;margin-top:20vh;}
  #usernameInput {padding:10px;font-size:18px;border-radius:8px;border:none;}
</style>
</head>
<body>

<div id="usernamePrompt">
  <h1>Enter your username to start:</h1>
  <input type="text" id="usernameInput" placeholder="Username">
  <button id="startBtn">Start Game</button>
</div>

<div class="container">
  <div class="game">
    <h1>Click to Breathe</h1>
    <p>Click or press SPACE to breathe and stay alive.</p>
    <button id="breathBtn">ðŸ’¨ Breathe</button>

    <div>
      Oxygen: <span id="oxygen">100</span>%
      <div class="bar"><div class="fill" id="oxyFill"></div></div>
      Air Points (AP): <span id="ap">0</span>
      <div class="bar"><div class="fill" id="apFill"></div></div>
    </div>

    <div class="stats">
      Breaths: <span id="breaths">0</span><br>
      Auto-breathers: <span id="autos">0</span>
    </div>

    <h2>Upgrades</h2>
    <div id="upgrades"></div>

    <div id="audioControls">
      <button id="muteBtn">ðŸ”ˆ Mute</button>
      Volume: <input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.2">
    </div>
  </div>

  <div class="leaderboard">
    <h2>Leaderboard</h2>
    <ol id="leaderboardList"></ol>
  </div>
</div>

<script>
  // --- AUDIO ---
  const breathSound = new Audio("breath.mp3");
  const ambientSound = new Audio("ambient.mp3");
  ambientSound.loop = true;
  ambientSound.volume = 0.2;
  const lowOxygenSound = new Audio("lowoxygen.mp3");

  // --- GAME STATE ---
  const s = {oxygen:100,maxOxygen:100,ap:0,breaths:0,auto:0,up:{di:0,lu:0,fi:0,au:0},last:0,cool:3000};
  const d = {
    di:{n:'Diaphragm Strength',b:5,desc:'+2 oxygen per click'},
    lu:{n:'Lung Capacity',b:25,desc:'+20 max oxygen'},
    fi:{b:50,n:'Carbon Filter',desc:'Slower oxygen drain'},
    au:{b:20,n:'Auto-breather',desc:'Breathes automatically'}
  };
  const cost = e => Math.floor(d[e].b*Math.pow(1.25,s.up[e]));

  const ox=document.getElementById('oxygen'),
        ap=document.getElementById('ap'),
        br=document.getElementById('breaths'),
        auT=document.getElementById('autos'),
        oxy=document.getElementById('oxyFill'),
        apF=document.getElementById('apFill'),
        upg=document.getElementById('upgrades'),
        leaderboardList = document.getElementById('leaderboardList');

  let playerName = "";

  function update(){
    ox.textContent = s.oxygen|0;
    ap.textContent = s.ap|0;
    br.textContent = s.breaths|0;
    auT.textContent = s.auto;
    oxy.style.width = s.oxygen/s.maxOxygen*100+'%';
    apF.style.width = Math.min(s.ap/10,1)*100+'%';
    upg.innerHTML = '';
    for(const e in d){
      const t=d[e],a=s.up[e],cst=cost(e);
      const b=document.createElement('button');
      b.textContent=`${t.n} (${cst} AP)`;
      b.disabled=s.ap<cst;
      b.onclick=()=>{
        if(s.ap>=cst){
          s.ap-=cst; s.up[e]++;
          if(e==='lu') s.maxOxygen+=20;
          if(e==='au') s.auto++;
          update();
        }
      };
      const div=document.createElement('div');
      div.textContent=`${t.desc} (Lvl ${a})`;
      div.appendChild(b);
      upg.appendChild(div);
    }
  }

  // --- BREATH FUNCTION ---
  function breathe(){
    const now = Date.now();
    if(now - s.last < s.cool) return;
    s.last = now;

    breathSound.currentTime = 0;
    breathSound.play().catch(()=>{});

    const baseGain = s.maxOxygen * 0.25;
    const upgradeGain = 2 * s.up.di;
    s.oxygen = Math.min(s.maxOxygen, s.oxygen + baseGain + upgradeGain);

    s.breaths++;
    s.ap += 2 + s.up.di;

    update();
    fetchLeaderboard(); // immediate leaderboard update
  }

  // --- TICK FUNCTION ---
  function tick(){
    s.oxygen -= 10/(1 + 0.2*s.up.fi);
    if(s.oxygen <=0){s.oxygen=10;s.ap=Math.max(0,s.ap-5);}

    if(s.oxygen < 25){
      lowOxygenSound.volume = 0.3;
      if(lowOxygenSound.paused) lowOxygenSound.play().catch(()=>{});
    } else { lowOxygenSound.pause(); lowOxygenSound.currentTime=0; }

    if(s.auto>0){
        const autoScale = 0.1;
        const baseGain = s.maxOxygen * 0.25;
        const upgradeGain = 2 * s.up.di;
        s.oxygen = Math.min(s.maxOxygen, s.oxygen + s.auto * autoScale * (baseGain + upgradeGain));
        s.ap += s.auto * autoScale * (2 + s.up.di);
        s.breaths += s.auto * autoScale;
    }

    update();
    fetchLeaderboard(); // live update for auto-breathers
  }

  // --- MUTE & VOLUME ---
  const muteBtn = document.getElementById('muteBtn');
  const volSlider = document.getElementById('volSlider');
  let isMuted = false;
  muteBtn.onclick = () => {
    isMuted = !isMuted;
    [ambientSound, breathSound, lowOxygenSound].forEach(a=>a.muted=isMuted);
    muteBtn.textContent = isMuted ? 'ðŸ”‡ Muted' : 'ðŸ”ˆ Mute';
  };
  volSlider.oninput = () => {
    [ambientSound, breathSound, lowOxygenSound].forEach(a=>a.volume=volSlider.value);
  };

  // --- LEADERBOARD ---
  const SHEET_URL = "https://script.google.com/macros/s/AKfycbwWPyZRvtoC4oFWcNThJJqtsc2Q4br91NMEZXvXFN8ncF05xVSX0w5atzWet0sx7jTeGQ/exec";

  async function fetchLeaderboard(){
    try {
      const res = await fetch(SHEET_URL);
      const data = await res.json();
      leaderboardList.innerHTML = '';

      data.sort((a,b)=>b[1]-a[1]);
      const top5 = data.slice(0,5);

      top5.forEach(entry=>{
        const li = document.createElement('li');
        li.textContent = `${entry[0]}: ${entry[1]} breaths`;
        if(entry[0]===playerName) li.style.color="#6ee7b7";
        leaderboardList.appendChild(li);
      });

      const inTop5 = top5.some(e=>e[0]===playerName);
      if(!inTop5){
        const current = data.find(e=>e[0]===playerName);
        if(current){
          leaderboardList.appendChild(document.createElement('hr'));
          const li = document.createElement('li');
          li.textContent = `${current[0]}: ${current[1]} breaths`;
          li.style.color="#6ee7b7";
          leaderboardList.appendChild(li);
        }
      }

    } catch(err){ console.error(err); }
  }

  function submitScore(){
    fetch(SHEET_URL,{
      method:"POST",
      body: JSON.stringify({name:playerName, breaths:s.breaths})
    }).catch(err=>console.error(err));
  }

  function breatheAndUpdate(){
    breathe();
  }

  // --- PROFANITY FILTER ---
  let profanityList = new Set();
  async function loadProfanityList(){
    const res = await fetch('https://raw.githubusercontent.com/LDNOOBW/List-of-Dirty-Naughty-Obscene-and-Otherwise-Bad-Words/master/en');
    const text = await res.text();
    text.split('\n').forEach(word => profanityList.add(word.trim().toLowerCase()));
  }

  function filterUsername(name){
    let clean = name.trim();
    profanityList.forEach(word => {
      const regex = new RegExp(word, "gi");
      clean = clean.replace(regex, "***");
    });
    return clean;
  }

  // --- START GAME ---
  const startBtn = document.getElementById('startBtn');
  const usernameInput = document.getElementById('usernameInput');
  const gameDiv = document.querySelector('.game');
  const leaderboardDiv = document.querySelector('.leaderboard');
  const usernamePrompt = document.getElementById('usernamePrompt');

  loadProfanityList().then(() => {
    startBtn.onclick = () => {
      let name = usernameInput.value.trim();
      if(!name){ alert("Please enter a username"); return; }

      playerName = filterUsername(name);

      usernamePrompt.style.display = "none";
      gameDiv.style.display = "block";
      leaderboardDiv.style.display = "block";

      setInterval(tick,1000);

      document.body.addEventListener("click", () => {
        if(ambientSound.paused) ambientSound.play().catch(()=>{});
      }, {once:true});

      window.addEventListener("beforeunload", submitScore);

      document.getElementById('breathBtn').onclick = breatheAndUpdate;
      window.onkeydown = e => { if(e.code==='Space') breatheAndUpdate(); };

      update();
    };
  });
</script>
</body>
</html>
